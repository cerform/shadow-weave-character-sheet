# Архитектура системы управления боем

## Обзор

Система управления боем в VTT полностью рефакторена для обеспечения надежности, производительности и простоты поддержки.

## Основные компоненты

### 1. BattleController (Централизованный контроллер)

**Файл:** `src/components/battle/BattleMapUI/core/BattleController.ts`

Главный контроллер, управляющий всей боевой системой:

- **Управление картой**: Загрузка, обновление, синхронизация карт
- **Управление токенами**: CRUD операции для боевых токенов
- **Туман войны**: Управление состоянием fog of war
- **Синхронизация в реальном времени**: WebSocket подключения через Supabase Realtime

#### Основные методы:

```typescript
// Инициализация
await controller.initialize();

// Управление картой
await controller.setMap(file: File);
await controller.setMapFromUrl(url: string);

// Управление токенами
const tokenId = await controller.addToken(token);
await controller.updateToken(id, updates);
await controller.removeToken(id);

// Туман войны
await controller.setFogCell(x, y, revealed);

// Подписка на изменения
const unsubscribe = controller.subscribe(() => {
  const state = controller.getState();
  // Обновление UI
});
```

### 2. useBattleController Hook

**Файл:** `src/components/battle/BattleMapUI/hooks/useBattleController.ts`

React хук, обертывающий BattleController:

```typescript
const {
  state,      // Текущее состояние боя
  loading,    // Статус загрузки
  error,      // Ошибки
  controller, // Прямой доступ к контроллеру
  // API методы
  setMap,
  setMapFromUrl,
  addToken,
  updateToken,
  removeToken,
  setFogCell,
} = useBattleController(sessionId);
```

### 3. BattleMapUI Component

**Файл:** `src/components/battle/BattleMapUI/BattleMapUI.tsx`

Основной UI компонент, использующий новую архитектуру:

- Автоматическая загрузка и синхронизация
- Обработка ошибок
- Индикаторы загрузки
- Интеграция с Fog of War и токенами

## Поток данных

```
┌─────────────────────────────────────────────────────────┐
│                    BattleMapUI                          │
│  ┌───────────────────────────────────────────────────┐  │
│  │         useBattleController Hook                   │  │
│  │  ┌─────────────────────────────────────────────┐  │  │
│  │  │        BattleController                     │  │  │
│  │  │  ┌───────────┐  ┌──────────┐  ┌─────────┐  │  │  │
│  │  │  │    Map    │  │  Tokens  │  │   Fog   │  │  │  │
│  │  │  └─────┬─────┘  └────┬─────┘  └────┬────┘  │  │  │
│  │  │        │             │             │        │  │  │
│  │  │        └─────────────┴─────────────┘        │  │  │
│  │  │                     │                        │  │  │
│  │  └─────────────────────┼────────────────────────┘  │  │
│  │                        │                           │  │
│  └────────────────────────┼───────────────────────────┘  │
│                           │                              │
└───────────────────────────┼──────────────────────────────┘
                            │
                    ┌───────▼────────┐
                    │   Supabase     │
                    │  ┌──────────┐  │
                    │  │ Realtime │  │
                    │  ├──────────┤  │
                    │  │ Database │  │
                    │  ├──────────┤  │
                    │  │ Storage  │  │
                    │  └──────────┘  │
                    └────────────────┘
```

## Синхронизация в реальном времени

### Каналы WebSocket:

1. **Карта** (`map-sync-${sessionId}`):
   - Слушает изменения `game_sessions.current_map_url`
   - Автоматически обновляет карту для всех участников

2. **Токены** (`tokens-sync-${sessionId}`):
   - INSERT: Добавление новых токенов
   - UPDATE: Обновление позиции/статов
   - DELETE: Удаление токенов

3. **Туман войны** (`fog-sync-${sessionId}`):
   - Только для игроков
   - DM управляет туманом напрямую

## База данных

### Таблицы:

- `game_sessions`: Основная информация о сессии, текущая карта
- `battle_maps`: Метаданные карт (размеры, пути к файлам)
- `battle_tokens`: Токены на карте
- `fog_of_war`: Состояние тумана войны по ячейкам

### Storage Buckets:

- `battle-maps`: Хранилище файлов карт

## Обработка ошибок

Система включает многоуровневую обработку ошибок:

1. **Уровень контроллера**: try/catch с логированием
2. **Уровень хука**: state.error для отображения
3. **Уровень UI**: Fallback компоненты

```typescript
if (battle.error) {
  return <ErrorDisplay error={battle.error} />;
}
```

## Производительность

### Оптимизации:

1. **Batching**: Обновления тумана войны батчируются (250ms)
2. **Memoization**: useMemo для тяжелых вычислений
3. **Selective updates**: Только измененные токены обновляются
4. **WebSocket**: Эффективная синхронизация в реальном времени

## Миграция со старой системы

Старые хуки (`useBattleMapState`, `useBattleTokens`) заменены на:
- `useBattleController` - единый источник истины

Преимущества:
- ✅ Меньше хуков = проще отладка
- ✅ Централизованное состояние
- ✅ Единая точка для логирования
- ✅ Упрощенная синхронизация
- ✅ Лучшая обработка ошибок

## Будущие улучшения

- [ ] Оффлайн режим с локальным кешем
- [ ] Undo/Redo для действий DM
- [ ] История изменений карты
- [ ] Автосохранение состояния боя
- [ ] Импорт/экспорт сцен
