import React from 'react';
import { Text } from '@react-three/drei';
import * as THREE from 'three';

import { useDraggable3D } from '@/hooks/useDraggable3D';

interface Equipment {
  id: string;
  name: string;
  type: 'weapon' | 'armor' | 'accessory' | 'helmet' | 'boots';
  modelPath?: string;
  stats?: {
    damage?: string;
    ac?: number;
    bonus?: string;
  };
}

interface DraggableMonsterModelProps {
  token: any;
  position: [number, number, number];
  isSelected: boolean;
  isHovered: boolean;
  onSelect: () => void;
  onMove: (x: number, y: number) => void;
  isDM?: boolean;
  onDragChange?: (dragging: boolean) => void;
}

// –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —ç–∫–∏–ø–∏—Ä–æ–≤–∫–∏ –¥–ª—è —Ç–æ–∫–µ–Ω–∞
const TokenEquipment: React.FC<{ equipment: Equipment[] }> = ({ equipment }) => {
  return (
    <>
      {equipment.map((item) => {
        const equipmentColor = item.type === 'weapon' ? '#fbbf24' : 
                              item.type === 'armor' ? '#6b7280' : 
                              item.type === 'helmet' ? '#3b82f6' : '#8b5cf6';
        
        const equipmentPosition = getDefaultEquipmentPosition(item.type);
        
        return (
          <group key={item.id} position={[equipmentPosition.x, equipmentPosition.y, equipmentPosition.z]}>
            {getEquipmentGeometry(item.type, equipmentColor)}
          </group>
        );
      })}
    </>
  );
};

// –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ —ç–∫–∏–ø–∏—Ä–æ–≤–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
const getDefaultEquipmentPosition = (type: string) => {
  switch (type) {
    case 'weapon': return { x: 0.5, y: 0.3, z: 0 };
    case 'armor': return { x: 0, y: 0.1, z: 0 };
    case 'helmet': return { x: 0, y: 1.5, z: 0 };
    case 'boots': return { x: 0, y: -0.3, z: 0 };
    default: return { x: 0, y: 0, z: 0 };
  }
};

// –ü–æ–ª—É—á–µ–Ω–∏–µ –≥–µ–æ–º–µ—Ç—Ä–∏–∏ —ç–∫–∏–ø–∏—Ä–æ–≤–∫–∏
const getEquipmentGeometry = (type: string, color: string) => {
  switch (type) {
    case 'weapon':
      return (
        <mesh>
          <cylinderGeometry args={[0.05, 0.05, 0.8]} />
          <meshStandardMaterial color={color} />
        </mesh>
      );
    case 'armor':
      return (
        <mesh>
          <boxGeometry args={[0.8, 1, 0.3]} />
          <meshStandardMaterial color={color} transparent opacity={0.6} />
        </mesh>
      );
    case 'helmet':
      return (
        <mesh>
          <sphereGeometry args={[0.25]} />
          <meshStandardMaterial color={color} />
        </mesh>
      );
    case 'boots':
      return (
        <mesh>
          <boxGeometry args={[0.3, 0.2, 0.4]} />
          <meshStandardMaterial color={color} />
        </mesh>
      );
    default:
      return (
        <mesh>
          <boxGeometry args={[0.15, 0.15, 0.15]} />
          <meshStandardMaterial color={color} />
        </mesh>
      );
  }
};

const DraggableMonsterModel: React.FC<DraggableMonsterModelProps> = ({
  token,
  position,
  isSelected,
  isHovered,
  onSelect,
  onMove,
  isDM = false,
  onDragChange,
}) => {
  const canMove = isDM || token.controlledBy === 'player1';
  
  const {
    groupRef,
    isDragging,
    handlePointerDown,
    handlePointerEnter,
    handlePointerLeave,
  } = useDraggable3D(canMove, onMove, onDragChange, onSelect);

  console.log(`üé≠ DraggableMonsterModel: ${token.name} (${token.monsterType}) can move: ${canMove}`);

  return (
    <group ref={groupRef} position={position}>
      {/* –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è - —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –¥–ª—è –ª—É—á—à–µ–≥–æ –∑–∞—Ö–≤–∞—Ç–∞ */}
      <mesh 
        position={[0, 0.5, 0]}
        visible={false}
        onPointerDown={handlePointerDown}
        onPointerEnter={handlePointerEnter}
        onPointerLeave={handlePointerLeave}
      >
        <cylinderGeometry args={[0.8, 0.8, 1.5, 8]} />
        <meshBasicMaterial transparent opacity={0} />
      </mesh>

      {/* –ü—Ä–æ—Å—Ç–æ–π —Ü–∏–ª–∏–Ω–¥—Ä –∫–∞–∫ —Ç–æ–∫–µ–Ω —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º –≤–Ω–µ—à–Ω–∏–º –≤–∏–¥–æ–º */}
      <mesh castShadow receiveShadow>
        <cylinderGeometry args={[0.4, 0.4, 0.8, 12]} />
        <meshStandardMaterial 
          color={token.color || '#3b82f6'}
          emissive={isSelected ? '#333333' : '#000000'}
          roughness={0.7}
          metalness={0.3}
        />
      </mesh>
      
      {/* –≠–∫–∏–ø–∏—Ä–æ–≤–∫–∞ —Ç–æ–∫–µ–Ω–∞ */}
      {token.equipment && token.equipment.length > 0 && (
        <TokenEquipment equipment={token.equipment} />
      )}

      {/* HP Bar —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º –¥–∏–∑–∞–π–Ω–æ–º */}
      {token.hp !== undefined && token.maxHp !== undefined && (
        <group position={[0, 2.5, 0]}>
          {/* –§–æ–Ω HP –±–∞—Ä–∞ */}
          <mesh position={[0, 0, 0.01]}>
            <planeGeometry args={[1.5, 0.15]} />
            <meshBasicMaterial color="#1a1a1a" />
          </mesh>
          {/* HP –±–∞—Ä */}
          <mesh position={[-(1.5 - (1.5 * token.hp / token.maxHp)) / 2, 0, 0.02]}>
            <planeGeometry args={[1.5 * token.hp / token.maxHp, 0.12]} />
            <meshBasicMaterial color={
              token.hp > token.maxHp * 0.7 ? '#22c55e' : 
              token.hp > token.maxHp * 0.4 ? '#eab308' : 
              token.hp > token.maxHp * 0.1 ? '#f97316' : '#ef4444'
            } />
          </mesh>
          {/* HP —Ç–µ–∫—Å—Ç —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç—å—é */}
          <Text
            position={[0, -0.25, 0.03]}
            fontSize={0.12}
            color="white"
            anchorX="center"
            anchorY="middle"
            outlineWidth={0.03}
            outlineColor="black"
          >
            {`${token.hp}/${token.maxHp}`}
          </Text>
        </group>
      )}

      {/* –ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–Ω—Å—Ç—Ä–∞ —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç—å—é - —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º */}
      {!isDragging && (
        <Text
          position={[0, 3, 0]}
          fontSize={0.4}
          color="white"
          anchorX="center"
          anchorY="middle"
          outlineWidth={0.08}
          outlineColor="black"
        >
          {token.name}
        </Text>
      )}

      {/* –í—ã–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –∏–ª–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π */}
      {(isSelected || isHovered) && (
        <mesh position={[0, 0.02, 0]} rotation={[-Math.PI / 2, 0, 0]}>
          <ringGeometry args={[0.8, 1.2, 32]} />
          <meshBasicMaterial 
            color={isSelected ? '#fbbf24' : '#ffffff'} 
            opacity={isSelected ? 0.8 : 0.4} 
            transparent 
          />
        </mesh>
      )}

      {/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —Å –ø—É–ª—å—Å–∞—Ü–∏–µ–π */}
      {isDragging && (
        <group position={[0, 3.5, 0]}>
          <mesh>
            <sphereGeometry args={[0.15]} />
            <meshBasicMaterial color="#ff4444" transparent opacity={0.8} />
          </mesh>
          <mesh position={[0, 0, 0]}>
            <ringGeometry args={[0.15, 0.25, 16]} />
            <meshBasicMaterial color="#ff6666" transparent opacity={0.4} />
          </mesh>
        </group>
      )}

      {/* –¢–µ–Ω—å –ø–æ–¥ —Ç–æ–∫–µ–Ω–æ–º */}
      <mesh position={[0, -0.4, 0]} rotation={[-Math.PI / 2, 0, 0]}>
        <circleGeometry args={[0.6, 32]} />
        <meshBasicMaterial color="#000000" opacity={0.2} transparent />
      </mesh>

      {/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */}
      {canMove && !isDragging && (
        <mesh position={[0, 0.05, 0]} rotation={[-Math.PI / 2, 0, 0]}>
          <ringGeometry args={[0.9, 1.0, 16]} />
          <meshBasicMaterial 
            color="#00ff00" 
            opacity={0.2} 
            transparent 
          />
        </mesh>
      )}
    </group>
  );
};

export default DraggableMonsterModel;