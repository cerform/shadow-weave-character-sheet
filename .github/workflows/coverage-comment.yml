name: Coverage Comment

on:
  workflow_run:
    workflows: ["Tests & Coverage"]
    types:
      - completed

permissions:
  pull-requests: write
  contents: read

jobs:
  comment:
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'failure'
    
    steps:
      - name: ğŸ“¥ Download coverage artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id,
            });
            
            const coverageArtifact = artifacts.data.artifacts.find(
              artifact => artifact.name === 'coverage-report'
            );
            
            if (coverageArtifact) {
              const download = await github.rest.actions.downloadArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: coverageArtifact.id,
                archive_format: 'zip',
              });
              
              const fs = require('fs');
              fs.writeFileSync('coverage.zip', Buffer.from(download.data));
            }

      - name: ğŸ“Š Extract and read coverage
        id: coverage
        run: |
          if [ -f coverage.zip ]; then
            unzip coverage.zip
            if [ -f coverage-summary.json ]; then
              LINES=$(cat coverage-summary.json | jq -r '.total.lines.pct')
              FUNCTIONS=$(cat coverage-summary.json | jq -r '.total.functions.pct')
              BRANCHES=$(cat coverage-summary.json | jq -r '.total.branches.pct')
              STATEMENTS=$(cat coverage-summary.json | jq -r '.total.statements.pct')
              
              echo "lines=$LINES" >> $GITHUB_OUTPUT
              echo "functions=$FUNCTIONS" >> $GITHUB_OUTPUT
              echo "branches=$BRANCHES" >> $GITHUB_OUTPUT
              echo "statements=$STATEMENTS" >> $GITHUB_OUTPUT
            fi
          fi

      - name: ğŸ’¬ Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const lines = '${{ steps.coverage.outputs.lines }}' || 'N/A';
            const functions = '${{ steps.coverage.outputs.functions }}' || 'N/A';
            const branches = '${{ steps.coverage.outputs.branches }}' || 'N/A';
            const statements = '${{ steps.coverage.outputs.statements }}' || 'N/A';
            
            const body = `## âŒ Coverage Threshold Check Failed!

Your PR does not meet the required coverage thresholds. Please add tests to increase coverage.

### ğŸ“Š Current Coverage

| Metric | Coverage | Required |
|--------|----------|----------|
| Lines | ${lines}% | 90% (critical), 80% (other) |
| Functions | ${functions}% | 90% (critical), 80% (other) |
| Branches | ${branches}% | 85% (critical), 75% (other) |
| Statements | ${statements}% | 90% (critical), 80% (other) |

### ğŸ”´ Critical Files (90% minimum)
- \`src/stores/**/*.ts\`
- \`src/components/battle/enhanced/**/*.tsx\`

### ğŸŸ¡ Other Files (80% minimum)
- All other source files

### ğŸ“š How to Fix

1. Run \`npm run test -- --coverage\` locally
2. Check which files need more tests
3. Add tests to reach the required thresholds
4. Commit and push your changes

See [COVERAGE_THRESHOLDS.md](../COVERAGE_THRESHOLDS.md) for more details.

---

ğŸ¤– This comment was automatically generated by the coverage check workflow.`;

            const pr = context.payload.workflow_run.pull_requests[0];
            if (pr) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: body
              });
            }
