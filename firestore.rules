
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // üßô‚Äç‚ôÇÔ∏è Characters ‚Äî –¥–æ—Å—Ç—É–ø –∫ —Å–≤–æ–∏–º –∏–ª–∏ —Å–µ—Å—Å–∏—è–º DM
    match /characters/{charId} {
      allow read, write: if request.auth != null && (
        request.auth.uid == resource.data.userId ||        // –∏–≥—Ä–æ–∫ ‚Äî –≤–ª–∞–¥–µ–ª–µ—Ü
        request.auth.uid == get(/databases/$(database)/documents/sessions/$(resource.data.sessionId)).data.dmId // –º–∞—Å—Ç–µ—Ä —Å–µ—Å—Å–∏–∏
      );
    }

    // üé≤ Sessions ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞—Å—Ç–µ—Ä—Å–∫–æ–π –ø–∞–Ω–µ–ª—å—é
    match /sessions/{sessionId} {
      allow read: if request.auth != null &&
        (request.auth.uid == resource.data.dmId || request.auth.uid in resource.data.players);
      allow write: if request.auth != null && request.auth.uid == resource.data.dmId;
    }

    // üë§ Users
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // üìñ Spells (readonly)
    match /spells/{spellId} {
      allow read: if request.auth != null;
      allow write: if false;
    }
  }
}
